version: "3.9"
services:
  prepare:
    image: ubuntu:latest
    user: ${MY_UID}:${MY_GID}
    volumes:
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - ../..:/tests
    command: >
      /bin/bash -c "id &&
      cd /tests/flow-over-heated-plate &&
      sed -i 's|m2n:sockets from|m2n:sockets network=\"eth0\" from|g' precice-config.xml"

  fluid-openfoam:
    depends_on:
      prepare:
        condition: service_completed_successfully
    image: "ghcr.io/precice/openfoam-adapter:${TAG_OPENFOAM_ADAPTER}"
    user: ${MY_UID}:${MY_GID}
    volumes:
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - ../..:/tests
    command: >
      /bin/bash -c "id && 
      cd /tests/flow-over-heated-plate/fluid-openfoam &&
      openfoam2112 ./run.sh | tee fluid-openfoam.log 2>&1"

  solid-openfoam:
    depends_on:
      prepare:
        condition: service_completed_successfully
    image: "ghcr.io/precice/openfoam-adapter:${TAG_OPENFOAM_ADAPTER}"
    user: ${MY_UID}:${MY_GID}
    volumes:
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - ../..:/tests
    command: >
      /bin/bash -c "id && 
      cd /tests/flow-over-heated-plate/solid-openfoam &&
      openfoam2112 ./run.sh | tee solid-openfoam.log 2>&1 &&
      cd /tests/flow-over-heated-plate/ &&
      tar -zxf reference-output.tar.gz"

  field-compare:
    build: https://github.com/dglaeser/fieldcompare-action.git # use the docker container provided by fieldcompare
    volumes:
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - ../..:/tests
    depends_on:
      fluid-openfoam:
        condition: service_completed_successfully
      solid-openfoam:
        condition: service_completed_successfully
    command:
      - /tests/flow-over-heated-plate/preCICE-output 
      - /tests/flow-over-heated-plate/reference-output

  cleanup:
    depends_on:
      field-compare:
        condition: service_completed_successfully
    image: ubuntu:latest
    user: ${MY_UID}:${MY_GID}
    volumes:
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - ../..:/tests
    command: >
      /bin/bash -c "id &&
      cd /tests/flow-over-heated-plate &&
      sed -i 's|m2n:sockets network=\"eth0\" from|m2n:sockets from|g' precice-config.xml"